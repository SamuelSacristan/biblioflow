pipeline {
    agent any
    
    tools {
        nodejs 'Node_24'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ RÃ©cupÃ©ration du code...'
                checkout scm
                sh 'ls -la'
            }
        }
        
        stage('Install Dependencies') {
            parallel {
                stage('Backend Dependencies') {
                    steps {
                        echo 'ğŸ”§ Installation des dÃ©pendances backend...'
                        dir('back') {
                            sh 'npm install'
                        }
                    }
                }
                stage('Frontend Dependencies') {
                    steps {
                        echo 'ğŸ”§ Installation des dÃ©pendances frontend...'
                        dir('front') {
                            sh 'npm install'
                        }
                    }
                }
            }
        }
        
        stage('Build Applications') {
            parallel {
                stage('Backend Build') {
                    steps {
                        echo 'ğŸ—ï¸ Build du backend...'
                        dir('back') {
                            sh 'npm run build'
                            sh 'ls -la dist/'
                        }
                    }
                }
                stage('Frontend Build') {
                    steps {
                        echo 'ğŸ—ï¸ Build du frontend...'
                        dir('front') {
                            sh 'npm run build'
                            sh 'ls -la dist/'
                        }
                    }
                }
            }
        }
        
        stage('Docker Build') {
            steps {
                echo 'ğŸ³ Construction des images Docker...'
                script {
                    // Build backend image
                    def backendImage = docker.build("biblioflow/backend:${env.BUILD_NUMBER}", "./back")
                    backendImage.tag("biblioflow/backend:latest")
                    
                    // Build frontend image  
                    def frontendImage = docker.build("biblioflow/frontend:${env.BUILD_NUMBER}", "./front")
                    frontendImage.tag("biblioflow/frontend:latest")
                    
                    echo "âœ… Images crÃ©Ã©es avec succÃ¨s !"
                }
            }
        }
        
        stage('Health Check') {
            steps {
                echo 'ğŸ” VÃ©rification des images...'
                sh 'docker images | grep biblioflow'
            }
        }
    }
    
    post {
        always {
            echo 'ğŸ§¹ Nettoyage...'
            cleanWs()
        }
        success {
            echo 'âœ… Pipeline terminÃ© avec succÃ¨s ! ğŸ‰'
        }
        failure {
            echo 'âŒ Pipeline Ã©chouÃ© ! ğŸ˜'
        }
    }
}